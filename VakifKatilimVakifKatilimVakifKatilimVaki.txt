using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Drawing;
using System.Drawing.Imaging;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Text;
using System.Windows;
using System.Windows.Media.Imaging;
using System.Windows.Threading;
using BOA.Common.Types;
using PdfSharp.Drawing;
using PdfSharp.Drawing.Layout;
using PdfSharp.Pdf;
using PdfSharp.Pdf.IO;
using PdfSharp;

namespace BOA.Pdf
{
    /// <summary>
    /// Pdf üzerinde yardımcı metodlar barındırır. 
    /// İlk çıkış amacı pdf dosyalarını birleştirmektir.
    /// Kaynak http://www.pdfsharp.com/PDFsharp/index.php?option=com_content&task=view&id=52&Itemid=60
    /// </summary>
    public class PdfHelper
    {
        #region Properties

        private const string HtmlToPdfExePath = "wkhtmltopdf.exe";

        private PdfDocument currentDocument = null;
        private string fileName = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData) + @"\VK\BOADocument.pdf";

        #endregion Properties

        #region Constructors & Destructor

        /// <summary>
        /// Constructor
        /// </summary>
        public PdfHelper()
        {
        }

        /// <summary>
        /// Destructor for cleanup
        /// </summary>
        ~PdfHelper()
        {
            Release();
        }

        #endregion Constructors

        #region Methods

        #region Create

        /// <summary>
        /// Verilen içeriği PDF dosyası olarak kaydeder
        /// </summary>
        /// <param name="title">Pdf Başlığı</param>
        /// <param name="content">Pdf İçeriği</param>
        /// <param name="filePath">Kaydedilecek dosya yolu</param>
        public void CreatePdfFile(string title, string content, string filePath)
        {
            using (PdfDocument document = new PdfDocument())
            {
                document.Info.Title = title;

                List<string> text = new List<string>();

                int g = 0;
                int x = 7000;
                while (true)
                {
                    if (g + x > content.Length)
                    {
                        text.Add(content.Substring(g, (content.Length - g)));
                        break;
                    }
                    else
                    {
                        text.Add(content.Substring(g, x));
                        g = g + x - 10;
                    }
                }

                foreach (var item in text)
                {
                    PdfPage page = document.AddPage();
                    XPdfFontOptions options = new XPdfFontOptions(PdfFontEncoding.Unicode, PdfFontEmbedding.Always);
                    XFont font = new XFont("Times New Roman", 10, XFontStyle.Bold, options);

                    using (XGraphics gfx = XGraphics.FromPdfPage(page))
                    {
                        XTextFormatter tf = new XTextFormatter(gfx);
                        //tf.Alignment = ParagraphAlignment.Left;

                        tf.DrawString(item, font, XBrushes.Black, new XRect(100, 100, page.Width - 200, 600), XStringFormats.TopLeft);
                    }
                }

                document.Save(filePath + ".pdf");
            };
        }

        public void CreateFromImage(string filePath, string imageLoc)
        {
            PdfDocument document = new PdfDocument();

            // Create an empty page or load existing

            Image imageFile = Image.FromFile(imageLoc);
            FrameDimension frameDimensions = new FrameDimension(
                imageFile.FrameDimensionsList[0]);

            // Gets the number of pages from the tiff image (if multipage)
            int frameNum = imageFile.GetFrameCount(frameDimensions);
            // Get an XGraphics object for drawing
            for (int frame = 0; frame < frameNum; frame++)
            {
                imageFile.SelectActiveFrame(frameDimensions, frame);
                Bitmap bmp = new Bitmap(imageFile);
                PdfPage page = document.AddPage();
                page.MediaBox = new PdfRectangle(new XRect(0, 0, bmp.Width, bmp.Height));
                XGraphics gfx = XGraphics.FromPdfPage(page);
                XImage image = XImage.FromBitmapSource(ImageHelper.CreateBitmapSource(bmp));
                gfx.DrawImage(image, 0, 0, bmp.Width, bmp.Height);
            }

            // Save 
            document.Save(filePath);
        }


        /// <summary>
        /// Html kodundan Pdf oluştur
        /// </summary>
        /// <param name="html"></param>
        /// <param name="paperSize"></param>
        /// <param name="dpi"></param>
        /// <returns></returns>
        public static bool CreateFromHtml(string html, Stream pdf, PdfParameters parameters)
        {
            ProcessStartInfo startInfo = new ProcessStartInfo();

            startInfo.FileName = Path.Combine(AssemblyPath, HtmlToPdfExePath);
            startInfo.WorkingDirectory = Path.GetDirectoryName(startInfo.FileName);

            startInfo.UseShellExecute = false;
            startInfo.CreateNoWindow = true;
            startInfo.RedirectStandardInput = true;
            startInfo.RedirectStandardOutput = true;
            startInfo.RedirectStandardError = true;

            if (parameters == null)
            {
                parameters = new PdfParameters();
            }

            StringBuilder wParams = new StringBuilder();

            wParams.Append("--quiet "); // Be less verbose

            if (parameters.Dpi.HasValue)
            {
                wParams.Append(string.Format("--dpi {0} ", parameters.Dpi.Value)); // Change the dpi explicitly
            }

            if (parameters.Grayscale)
            {
                wParams.Append("--grayscale "); // PDF will be generated in grayscale
            }

            if (parameters.ImageDpi.HasValue)
            {
                wParams.Append(string.Format("--image-dpi {0} ", parameters.ImageDpi.Value)); // When embedding images scale them down to this dpi (default 600)
            }

            if (parameters.ImageQuality.HasValue)
            {
                wParams.Append(string.Format("--image-quality {0} ", parameters.ImageQuality.Value)); // When jpeg compressing images use this quality (default 94)
            }

            if (parameters.LowQuality)
            {
                wParams.Append("--lowquality "); // Generates lower quality pdf/ps. Useful to shrink the result document space
            }

            if (parameters.MarginTop.HasValue)
            {
                wParams.Append(string.Format("--margin-top {0}mm ", parameters.MarginTop.Value)); // Set the page bottom margin
            }

            if (parameters.MarginBottom.HasValue)
            {
                wParams.Append(string.Format("--margin-bottom {0}mm ", parameters.MarginBottom.Value)); // Set the page bottom margin
            }

            if (parameters.MarginLeft.HasValue)
            {
                wParams.Append(string.Format("--margin-left {0}mm ", parameters.MarginLeft.Value)); // Set the page bottom margin
            }

            if (parameters.MarginRight.HasValue)
            {
                wParams.Append(string.Format("--margin-right {0}mm ", parameters.MarginRight.Value)); // Set the page bottom margin
            }

            wParams.Append(string.Format("--orientation {0} ", parameters.Orientation.ToString())); // Set orientation to Landscape or Portrait (default Portrait)
            wParams.Append(string.Format("--output-format {0} ", parameters.OutputFormat.ToString())); // Specify an output format to use pdf or ps, instead of looking at the extention of the output filename

            if (parameters.PageSize != null)
            {
                wParams.Append(string.Format("--page-width {0}mm ", parameters.PageSize.Width)); // Page width
                wParams.Append(string.Format("--page-height {0}mm ", parameters.PageSize.Height)); // Page width
            }
            else
            {
                wParams.Append(string.Format("--page-size {0} ", parameters.PreDefinedPageSize.ToString())); // Set paper size to: A4, Letter, etc. (default A4)
            }

            if (parameters.NoPdfCompression)
            {
                wParams.Append("--no-pdf-compression "); // Do not use lossless compression on pdf objects
            }

            if (!string.IsNullOrEmpty(parameters.Title))
            {
                wParams.Append(string.Format("--title \"{0}\" ", parameters.Title)); // The title of the generated pdf file (The title of the first document is used if not specified)
            }

            wParams.Append(string.Format("--encoding {0} ", parameters.Encoding.WebName)); // Set the default text encoding, for input

            if (parameters.EnableExternalLinks)
            {
                wParams.Append("--enable-external-links "); // Make links to remote web pages (default)
            }
            else
            {
                wParams.Append("--disable-external-links "); // Do not make links to remote web pages
            }

            if (parameters.EnableInternalLinks)
            {
                wParams.Append("--enable-internal-links "); // Make local links (default)
            }
            else
            {
                wParams.Append("--disable-internal-links "); // Do not make local links
            }

            if (parameters.EnableForms)
            {
                wParams.Append("--enable-forms "); // Turn HTML form fields into pdf form fields
            }
            else
            {
                wParams.Append("--disable-forms "); // Do not turn HTML form fields into pdf form fields (default)
            }

            if (parameters.EnableImages)
            {
                wParams.Append("--images "); // Do load or print images (default)
            }
            else
            {
                wParams.Append("--no-images "); // Do not load or print images
            }

            if (parameters.EnableJavascript)
            {
                wParams.Append("--enable-javascript "); // Do allow web pages to run javascript (default)
            }
            else
            {
                wParams.Append("--disable-javascript "); // Do not allow web pages to run javascript
            }

            if (parameters.EnableSmartShrinking)
            {
                wParams.Append("--enable-smart-shrinking "); // Enable the intelligent shrinking strategy used by WebKit that makes the pixel/dpi ratio none constant (default)
            }
            else
            {
                wParams.Append("--disable-smart-shrinking "); // Disable the intelligent shrinking strategy used by WebKit that makes the pixel/dpi ratio none constant
            }

            wParams.Append("- -"); // ?

            startInfo.Arguments = wParams.ToString();

            try
            {
                using (var process = Process.Start(startInfo))
                {
                    byte[] buffer = parameters.Encoding.GetBytes(html);

                    StreamWriter stdin = process.StandardInput;
                    stdin.AutoFlush = true;
                    stdin.BaseStream.Write(buffer, 0, buffer.Length);
                    stdin.Dispose();

                    CopyStream(process.StandardOutput.BaseStream, pdf);
                    process.StandardOutput.Close();
                    pdf.Position = 0;

                    process.WaitForExit(30 * 1000);
                }

                return true;
            }
            catch
            {
                return false;
            }
        }

        #endregion Create

        #region Merge

        /// <summary>
        /// Pdf dosyalarını birleştirir
        /// </summary>
        /// <param name="files">Dosya yolları dizisi</param>
        /// <returns>Birleştirilmiş Pdf'lerin PdfDocument nesnesi</returns>
        public PdfDocument PdfMerge(string[] files)
        {
            // Get some file names

            // Open the output document
            currentDocument = new PdfDocument();

            // Iterate files
            foreach (string file in files)
            {
                // Open the document to import pages from it.
                PdfDocument inputDocument = PdfReader.Open(file, PdfDocumentOpenMode.Import);

                // Iterate pages
                int count = inputDocument.PageCount;
                for (int idx = 0; idx < count; idx++)
                {
                    // Get the page from the external document...
                    PdfPage page = inputDocument.Pages[idx];
                    // ...and add it to the output document.
                    currentDocument.AddPage(page);
                }
            }

            // Save the document...

            // outputDocument.Save(filename);
            // ...and start a viewer.
            // Process.Start(filename);
            return currentDocument;
        }

        /// <summary>
        /// Bir Xps ve bir Pdf dosyasını birleştirir
        /// </summary>
        /// <param name="xpspath"></param>
        /// <param name="pdfPath"></param>
        /// <returns>Birleştirilmiş Pdf'lerin PdfDocument nesnesi</returns>
        public PdfDocument PdfMerge(string xpspath, string pdfPath)
        {
            // Open the output document
            currentDocument = new PdfDocument();
            PdfDocument inputDocument = PdfReader.Open(pdfPath, PdfDocumentOpenMode.Import);
            PdfDocument xpspdf = this.XpsToPdf(xpspath);
            // Iterate files

            // Open the document to import pages from it.

            // Iterate pages
            int count = xpspdf.PageCount;
            for (int idx = 0; idx < count; idx++)
            {
                // Get the page from the external document...
                PdfPage page = inputDocument.Pages[idx];
                // ...and add it to the output document.
                currentDocument.AddPage(page);
            }

            int counts = inputDocument.PageCount;
            for (int idx = 0; idx < counts; idx++)
            {
                // Get the page from the external document...
                PdfPage page = inputDocument.Pages[idx];
                // ...and add it to the output document.
                currentDocument.AddPage(page);
            }

            // Save the document...

            // outputDocument.Save(filename);
            // ...and start a viewer.
            // Process.Start(filename);
            return currentDocument;
        }

        #endregion PdfMerge

        #region Save

        /// <summary>
        /// Aktif PDF nesnesini default konuma kaydeder
        /// </summary>
        public void Save()
        {
            if (currentDocument != null)
            {
                currentDocument.Save(fileName);
                this.Release();
            }
        }

        /// <summary>
        /// Aktif PDF nesnesini verilen konuma kaydeder
        /// </summary>
        /// <param name="filePath"></param>
        public void Save(string filePath)
        {
            if (currentDocument != null)
            {
                currentDocument.Save(filePath);
                this.Release();
            }
        }

        /// <summary>
        /// Pdf nesnesini default konuma kaydeder
        /// </summary>
        public void Save(PdfDocument document)
        {
            if (document != null)
            {
                document.Save(fileName);
            }
        }

        /// <summary>
        /// Pdf nesnesini verilen konuma kaydeder
        /// <param name="document"></param>
        /// <param name="filePath"></param>
        /// </summary>
        public static void Save(PdfDocument document, string filePath)
        {
            if (document != null)
            {
                document.Save(filePath);
            }
        }

        #endregion Save

        #region Show

        /// <summary>
        ///show Document.
        /// </summary>
        public void showPdf()
        {
            Process.Start(this.fileName);
        }

        #endregion Show

        #region Convert

        /// <summary>
        /// Convert Xps to Pdf
        /// </summary>
        /// <param name="filepath"></param>
        /// <returns></returns>
        public PdfDocument XpsToPdf(string filepath)
        {
            currentDocument = PdfSharp.Xps.XpsConverter.Convert(filepath, this.fileName, 0, false);
            return currentDocument;
        }


        /// <summary>
        /// 
        /// </summary>
        /// <param name="xpsPath"></param>
        /// <param name="pdfPath"></param>
        /// <returns></returns>
        public PdfDocument XpsToPdf(string xpsPath, string pdfPath)
        {
            currentDocument = PdfSharp.Xps.XpsConverter.Convert(xpsPath, pdfPath, 0, false);
            return currentDocument;
        }

        /// <summary>
        /// Aktif Pdf'i stream olarak döner
        /// </summary>
        /// <returns></returns>
        public Stream ConvertToStream()
        {
            if (currentDocument != null)
            {
                try
                {
                    MemoryStream stream = new MemoryStream();
                    currentDocument.Save(stream, false);
                    return stream;
                }
                catch { }
            }

            return null;
        }

        /// <summary>
        /// Pdf nesnesini stream olarak döner
        /// </summary>
        /// <param name="document"></param>
        /// <returns></returns>
        public static Stream ConvertToStream(PdfDocument document)
        {
            if (document != null)
            {
                try
                {
                    MemoryStream stream = new MemoryStream();
                    document.Save(stream, false);
                    return stream;
                }
                catch { }
            }

            return null;
        }

        /// <summary>
        /// Aktif Pdf'i byte dizisi olarak döner
        /// </summary>
        /// <returns></returns>
        public byte[] ConvertToByteArray()
        {
            byte[] content = null;

            if (currentDocument != null)
            {
                try
                {
                    using (MemoryStream stream = new MemoryStream())
                    {
                        currentDocument.Save(stream, true);
                        content = stream.ToArray();
                    }
                }
                catch { }
            }

            return content;
        }

        /// <summary>
        /// Pdf nesnesini byte dizisi olarak döner
        /// </summary>
        /// <param name="document"></param>
        /// <returns></returns>
        public static byte[] ConvertToByteArray(PdfDocument document)
        {
            byte[] content = null;

            if (document != null)
            {
                try
                {
                    using (MemoryStream stream = new MemoryStream())
                    {
                        document.Save(stream, true);
                        content = stream.ToArray();
                    }
                }
                catch { }
            }

            return content;
        }

        #endregion

        #endregion Methods

        #region Helper Methods

        /// <summary>
        /// Aktif PDF nesnesini kapatır
        /// </summary>
        public void Release()
        {
            try
            {
                if (currentDocument != null)
                {
                    currentDocument.Close();
                    currentDocument.Dispose();
                    currentDocument = null;
                }
            }
            catch { }
        }

        #region Private Methods

        private static string AssemblyPath
        {
            get
            {
                return Path.GetDirectoryName((new Uri(Assembly.GetExecutingAssembly().GetName().CodeBase)).LocalPath);
            }
        }

        private static bool InvokeRequired
        {
            get
            {
                if (Application.Current == null)
                {
                    return false;
                }

                return Dispatcher.CurrentDispatcher != Application.Current.Dispatcher;
            }
        }

        private static BitmapSource CreateBitmapSourceFromBitmap(Bitmap bitmap)
        {
            if (bitmap == null)
            {
                throw new ArgumentNullException("bitmap");
            }

            try
            {
                using (MemoryStream memoryStream = new MemoryStream())
                {
                    // You need to specify the image format to fill the stream. 
                    // I'm assuming it is PNG
                    bitmap.Save(memoryStream, ImageFormat.Png);
                    memoryStream.Seek(0, SeekOrigin.Begin);

                    // Make sure to create the bitmap in the UI thread
                    if (InvokeRequired)
                    {
                        return (BitmapSource)Application.Current.Dispatcher.Invoke(
                            new Func<Stream, BitmapSource>(CreateBitmapSourceFromBitmap),
                            DispatcherPriority.Normal,
                            memoryStream);
                    }

                    return CreateBitmapSourceFromBitmap(memoryStream);
                }
            }
            catch (Exception)
            {
                return null;
            }
        }

        private static BitmapSource CreateBitmapSourceFromBitmap(Stream stream)
        {
            BitmapDecoder bitmapDecoder = BitmapDecoder.Create(
                stream,
                BitmapCreateOptions.PreservePixelFormat,
                BitmapCacheOption.OnLoad);

            // This will disconnect the stream from the image completely...
            WriteableBitmap writable = new WriteableBitmap(bitmapDecoder.Frames.Single());
            writable.Freeze();

            return writable;
        }

        private static void CopyStream(Stream input, Stream output)
        {
            byte[] buffer = new byte[32 * 1024];
            int read;
            while ((read = input.Read(buffer, 0, buffer.Length)) > 0)
            {
                output.Write(buffer, 0, read);
            }
        }

        #endregion

        #endregion
    }

    public class PdfParameters
    {
        public PdfParameters()
        {
            Encoding = Encoding.UTF8;
            PreDefinedPageSize = PdfPageSize.A4;
            Orientation = PdfPageOrientation.Portrait;
            OutputFormat = PdfOutputFormat.pdf;
            EnableImages = true;
        }

        public string Title { get; set; }
        public Encoding Encoding { get; set; }

        public short? Dpi { get; set; }
        public bool Grayscale { get; set; }
        public short? ImageDpi { get; set; }
        public byte? ImageQuality { get; set; }
        public bool LowQuality { get; set; }

        public short? MarginTop { get; set; }
        public short? MarginBottom { get; set; }
        public short? MarginLeft { get; set; }
        public short? MarginRight { get; set; }
        public PdfPageOrientation Orientation { get; set; }
        public PdfOutputFormat OutputFormat { get; set; }
        public PdfPageSize PreDefinedPageSize { get; set; }
        public PaperSize PageSize { get; set; }

        public bool NoPdfCompression { get; set; }
        public bool EnableExternalLinks { get; set; }
        public bool EnableInternalLinks { get; set; }
        public bool EnableForms { get; set; }
        public bool EnableImages { get; set; }
        public bool EnableJavascript { get; set; }
        public bool EnableSmartShrinking { get; set; }
    }

    public enum PdfPageOrientation
    {
        Portrait,
        Landscape
    }

    public enum PdfOutputFormat
    {
        pdf,
        ps
    }

    public enum PdfPageSize
    {
        A4,
        Letter
    }
}